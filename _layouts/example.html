<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>{{ site.title }} | {{ page.title }}</title>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
        <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-deep-orange.css">
		<link rel="stylesheet" href="/pages/code-theme.css">
		<link rel="stylesheet" href="/pages/spinner.css">
		<link rel="stylesheet" href="/pages/style.css">
        <script src="https://elementa.js.org/dist/0.4.0.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <style>
            video {
                display: inline-block;
            }
            .container { max-width: 80vw; margin: auto; margin-top: 1vh; }
            .hidden { display: none; }

            html {
                scroll-behavior: smooth;
            }

            .hash {
                background-color: #f1f1f1;
                color: #333;
                font-family: monospace;
                padding: 0.2em 0.4em;
                border-radius: 4px;
                overflow-wrap: anywhere;
            }

        </style>

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QGWBDVQ8B"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-9QGWBDVQ8B');
        </script>

    </head>
	<body class="w3-black">
		<div id="loading">
			 <div class="spinner"></div>
		</div>

        <template id="site-menu">
            <div class="w3-container">
                <div class="w3-bar">
                    <a class="w3-bar-item w3-button w3-text-theme w3-large" href="https://transparentlottery.com">
                        <b>{{ site.title }}</b>
                    </a>
                    <span class="w3-bar-item">
                        {{ site.description }}
                    </span>
                </div>
            </div>
            <div class="w3-container">
                <div class="w3-bar">
                    <a class="w3-bar-item w3-button" href="https://transparentlottery.com/#how-it-works">How it works</a>
                    <a class="w3-bar-item w3-button" href="{{ site.github_url }}">View on GitHub</a>
                    <a class="w3-bar-item w3-button w3-theme w3-round" href="https://transparentlottery.com/example">Example</a>
                </div>
            </div>
        </template>

        <template id="result-description" tag="li"></template>

        <template id="result-resume">
            <div class="w3-padding">
                <table class="w3-table w3-bordered" style="width: 15vw;">
                    <tr>
                        <td>Bitcoin Block</td>
                        <td id="height"></td>
                    </tr>
                    <tr>
                        <td>Roll Number</td>
                        <td id="roll"></td>
                    </tr>
                    <tr>
                        <td>Game Base</td>
                        <td id="base"></td>
                    </tr>
                </table>
            </div>
        </template>

        <template id="ball" tab="b">
            <span id="value" class="w3-tag w3-margin-right w3-margin-bottom w3-round w3-card w3-round-xxlarge w3-bold w3-large w3-theme"></span>
        </template>

        <!-- Donation -->
        <a class="w3-button w3-block w3-theme w3-hover-theme" onclick="document.getElementById('donation').style.display='block'">{{ site.title }} need your support!</a>
        <div id="donation" class="w3-modal">
        <div class="w3-modal-content w3-white w3-round">
            <div class="w3-container">
                <span class="w3-button w3-display-topright" onclick="document.getElementById('donation').style.display='none'">&times;</span>
                <div class="w3-container w3-padding-32 w3-center">
                    <h3 class="w3-text-theme w3-center">Donate to {{ site.title }}</h3>
                    <hr>
                    <p>
                        Send us any value to the address:<br>
                        <b>
                            <span id="donation-address"></span>
                        </b>
                    </p>
                    <hr>
                    <p>You can use this QR code in your wallet to send us any value:</p>
                    <p>
                        <img id="donation-qrcode" src=""><br>
                    </p>
                    <p>
                        <span id="donation-transaction" class="w3-small"></span><br>
                        <button id="donation-copy" class="w3-small w3-button w3-round w3-theme" onclick="copy_to_clipboard()">Copy transaction and paste in your wallet.</button>
                    </p>
                    <hr>
                    <p>Thanks for your support!</p>
                    <script>
                        const button      = "Copy transaction and paste in your wallet.";
                        const message     = "{{ site.title }} donation";
                        const address     = "{{ site.donation_address }}";
                        const transaction = `bitcoin:${address}?label=${encodeURIComponent(message)}&message=${encodeURIComponent(message)}`;
                        const qrcode      = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(transaction)}`;

                        document.getElementById("donation-qrcode").src            = qrcode;
                        document.getElementById("donation-address").innerText     = address;
                        document.getElementById("donation-transaction").innerText = transaction;
                        document.getElementById("donation-copy").innerText        = button;

                        async function copy_to_clipboard()
                        {
                            await navigator.clipboard.writeText(transaction);
                            document.getElementById("donation-copy").innerText = "Copied!";
                            setTimeout(function() {
                                document.getElementById("donation-copy").innerText = button;
                            }, 2000);
                        }
                    </script>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="w3-padding-32 w3-center w3-white">
            <site-menu></site-menu>
        </div>

        <!-- Main -->
        <div class="w3-padding-32 w3-white">
            <div class="w3-content">
                <div class="w3-padding">
                    <h1>Transparent Lottery Example</h1>
                    <div id="form" class="w3-animate-opacity" hidden>
                        <H2>Game Settings</H2>
                        <label class="w3-margin-top">
                            <b class="w3-text-theme">Game Base</b><br/>
                            <span class="w3-small">Number of options for each game play.</span>
                        </label>
                        <input type="number" id="base-input" class="w3-input" min="2" max="256" value="6",>

                        <label class="w3-margin-top">
                            <b class="w3-text-theme">Bitcoin Block</b><br/>
                            <span class="w3-small">Height of Bitcoin block.</span>
                        </label>
                        <input type="number" id="block-input" class="w3-input" min="0" value="0">

                        <label class="w3-margin-top">
                            <b class="w3-text-theme">Roll Number</b><br/>
                            <span class="w3-small">Roll applied in the draw seed number.</span>
                        </label>
                        <input type="number" id="roll-input" class="w3-input" min="0" value="0">
                            <button class="w3-button w3-theme w3-text-white w3-margin-top w3-block w3-round" onclick="show_results()">Check Results</button>
                    </div>
                    <div id="results-box" class="w3-animate-opacity" hidden>
                        <button class="w3-button w3-theme w3-round w3-small" onclick="toogle('explanation')">Get out results youself</button>
                        <div id="explanation" class="w3-hide">
                            <h2>How To Get Results</h2>
                            <div class="w3-container">
                                <ul id="result-descriptions" class="w3-ul"></ul>
                            </div>
                        </div>
                        <h2>Draw Results</h2>
                        <div class="w3-padding">
                            <p id="result-balls" class="w3-container"></p>
                        </div>
                        <div id="show-form-button" hidden>
                            <button class="w3-button w3-theme w3-text-white w3-margin-top w3-block w3-round" onclick="show_form()">Check New Results</button>
                        </div>
                    </div>
                </div>
			</div>
        </div>
        <script>
            async function set_block_input_default()
            {
                try {
                    let response = await fetch("https://mempool.space/api/blocks/tip/height");
                    const height = await response.json();
                    document.getElementById("block-input").value = height;
                } catch(error) {
                    console.error(error);
                    document.getElementById("block-input").value = "0";
                }
                document.getElementById("form").style.display = "block";
            }
            set_block_input_default();

            function toogle(id) {
                let element = document.getElementById(id);
                if (element.className.indexOf("w3-show") == -1) {
                    element.className += " w3-show";
                } else {
                    element.className = element.className.replace(" w3-show", "");
                }
            }

            async function show_results()
            {
                clear_results();
                document.getElementById("form").style.display             = "none";
                document.getElementById("show-form-button").style.display = "none";
                document.getElementById("results-box").style.display      = "block";
                await get_results();
                document.getElementById("show-form-button").style.display = "block";
            }

            function clear_results()
            {
                clearTimeout(window.timeout);
                document.getElementById("result-balls").innerHTML = "";
                document.getElementById("result-descriptions").innerHTML = "";
            }

            async function get_results()
            {
                let results_data = await draw();
                let results_balls = document.getElementById("result-balls");
                let index_value   = 0;

                for (let result of results_data.results) {
                    await sleep(100);
                    let result_ball = elementa.render.tag("ball", {"value": ++result});
                    results_balls.appendChild(result_ball);
                }
            }

            async function draw()
            {
                let input   = get_input();
                let height  = input.block;
                let base    = input.base;
                let roll    = input.rool;
                let block   = await get_block(height);
                let hash    = block.hash;
                let instant = block.instant;
                let results = await generate_draw_numbers(hash, base, roll);
                add_result_description(`<i>We added 1 to each result to be more intuitive, as the first possibity is 0.</i>`);
                document.getElementById("result-balls").appendChild(elementa.render.tag("result-resume", {height, roll, base}));
                return {height, hash, results};
            }

            function get_input()
            {
                let block = document.getElementById("block-input").value;
                let base  = document.getElementById("base-input").value;
                let rool  = document.getElementById("roll-input").value;

                console.log("block:", block);
                console.log("base:",  base);
                console.log("roll:",  rool);
                return {block, base, rool};
            }

            async function get_block(height)
            {
                add_result_description(`<i>Get the hash of block</i> <spam class="hash">${height}</spam> in <button class="w3-button w3-light-gray w3-round" onclick="window.open('https://mempool.space/block/${height}', '_blank');">Bitcoin Mempool</button>`);

                let hash    = null;
                let instant = null;
                try {
                    let response = await fetch(`https://mempool.space/api/block-height/${height}`);
                    if (!response.ok) {
                        if (response.status == 404) {
                            return block_estimate(height);
                        }
                        throw `Failed to get block ${height}: Error ${response.status}: ${await response.text()}`;
                    }
                    hash = await response.text();

                    response = await fetch(`https://mempool.space/api/block/${hash}`);
                    if (!response.ok) {
                        throw `Failed to get block ${hash}: ${response.statusText}`;
                    }

                    const data      = await response.json();
                    const timestamp = data.timestamp;
                    instant         = new Date(timestamp * 1000).toLocaleString();
                } catch (error) {
                    return show_error(error);
                }

                add_result_description(`<i>Get the <b>Hash</b> of block ${height}. It's Seed Draw Number: </i><spam class="hash">${hash}</spam>. <i>It was mined at ${instant}.</i>`);
                console.log("hash:",    hash);
                console.log("instant:", instant);
                return {hash, instant};
            }

            function add_result_description(description)
            {
                console.log(description);
                document.getElementById("result-descriptions").appendChild(elementa.render.tag("result-description", null, description));
            }

            function show_error(error)
            {
                console.error(error);
                document.getElementById("results-box").style.display = "block";
                document.getElementById("result-balls").innerHTML = error;
            }

            async function block_estimate(height) {
                let response         = await fetch("https://mempool.space/api/blocks/tip/height");
                const current_height = await response.json();

                response                = await fetch("https://mempool.space/api/blocks");
                const blocks            = await response.json();
                const current_timestamp = blocks[0].timestamp;
                const delta_blocks      = height - current_height;

                if (delta_blocks < 0) {
                    return show_error(`Block ${height} already mined.`);
                }

                const seconds = delta_blocks * 10 * 60;
                const date = new Date((current_timestamp + seconds) * 1000);
                return show_error(`<h4>Wait Draw</h4><p>The block ${height} is not mined. Current block is ${current_height}. Please, wait mining and return back later.</p><p>Draw estimation:</p><p><b>${date.toLocaleString()}</b></p>`);
            }

            async function generate_drawing_rool_number(seed, roll) {

                add_result_description(`<i>Draw Rool Number 0 is the Seed Draw Number.</i>`);

                if (roll > 0) {
                    add_result_description(`<i>Apply the SHA256 hash function ${roll} time to get Draw Rool Number.</i>`);
                }

                let result = seed;
                console.log("rolling", seed, roll, "x");
                console.log("roll: 0", "draw roll number:", result);

                for (let current_roll = 0; current_roll < roll; current_roll++) {
                    let bytes = new Uint8Array(result.length / 2);
                    for (let position = 0; position < result.length; position += 2) {
                        bytes[position / 2] = parseInt(result.substr(position, 2), 16);
                    }
                    const hash = await crypto.subtle.digest("SHA-256", bytes);
                    result = Array.from(new Uint8Array(hash)).map(function (value) {
                        return value.toString(16).padStart(2, "0");
                    }).join("");
                    console.log("roll:", current_roll + 1, "draw roll number:", result);
                    add_result_description(`<i>Draw Rool Number ${current_roll + 1}: <spam class="hash">${result}</spam>.`);
                }

                return result;
            }

            async function generate_draw_numbers(hash, base, roll)
            {
                hash = await generate_drawing_rool_number(hash, roll);
                try {
                    hash = hash.padStart(64, '0');
                    add_result_description(`<i>Add zeros to the left of the Seed Draw Number to ensure it has 64 characters: <spam class="hash">${hash}</spam>`);

                    let seed = BigInt('0x' + hash);
                    base = BigInt(base);
                    add_result_description(`<i>Convert the Seed Draw Number to base 10 for further calculations using JavaScript: <spam class="hash">${hash}</spam></i><div class="w3-code jsHigh notranslate">let seed_draw_number_base_10 = BigInt('0x' + '${seed}')<br>// seed_draw_number_base_10 = ${seed}</div>`);
                    add_result_description(`<i>Convert the Seed Draw Number to Game Base dividing it by ${base} to get Draw Numbers. Each Draw Number is the rest the each division.</i>`);

                    let numbers = [];
                    while (seed > 0) {
                        if (seed / base > 0) {
                            add_result_description(`${seed} ÷ ${base} = ${seed / base} and rest ${seed % base}. <spam class="hash">${seed % base}</spam> is a Draw Number.`);
                        } else {
                            add_result_description(`${seed} ÷ ${base} = ${seed / base} and rest ${seed % base}. <spam class="hash">${seed % base}</spam> is a Draw Number. The last result of division is zero, then stop division.`);
                        }
                    
                        numbers.push(Number(seed % base));
                        seed = seed / base;
                    }
                    
                    results = numbers.reverse();
                    add_result_description(`Revert sequence of results to get Draw Numbers:</i> <spam class="hash">${results}</spam>`);
                    return results;
                } catch (error) {
                    console.error(hash, error);
                    return `${hash} ${error}`;
                }
            }

            async function sleep(ms)
            {
                await new Promise(function(resolve) {
                    window.timeout = setTimeout(resolve, ms);
                });
            }

            async function show_form()
            {
                clear_results()
                document.getElementById("results-box").style.display = "none";
                document.getElementById("form").style.display        = "block";
            }
        </script>

        <footer class="div-d w3-container w3-center w3-padding-64 w3-margin-top w3-black">
            <div class="w3-padding-64"></div>
		    <div>
                <site-menu></site-menu>
                <div class="w3-container">
                    <div class="w3-bar">
                        <a class="w3-bar-item w3-button" onclick="document.getElementById('donation').style.display='block'">Help us</a>
                    </div>
                </div>
                <p class="w3-tiny">Copyright (c) {{ site.time | date: "%Y" }} D. H. B. Marcos.<br>Deo omnis gloria.</p>
            </div>
		</footer>
	</body>
    <script>
        window.addEventListener("load", function() {
            const loading = document.getElementById("loading");
            loading.classList.add("fade-out");

            loading.addEventListener("transitionend", function() {
                loading.remove();
            });
        });
  	</script>
  </html>
